<!DOCTYPE html>
<html>
<head>
	<title>Recipe Editor</title>
	<script type='text/javascript' src='js/knockout-2.0.0.js'></script>
	<script type='text/javascript' src='js/knockout.mapping-latest.js'></script>
	<script type='text/javascript' src='js/jquery-1.7.2.min.js'></script>
	<script type='text/javascript' src='js/jquery-ui-1.8.18.custom.min.js'></script>
</head>
<body>
<form action="#">
<div data-bind="with: data">
	<h1 data-bind="text: title">Titel</h1>
	<img src="images/tango/32x32/status/image-missing.png" alt="recipe" data-bind="attr: {src: image.src}"/>
	<div>Foto von <span data-bind="text: image.author"></span></div>
	Kategorien:
	<ul data-bind="foreach: categories">
		<li data-bind="text: $data"></li>
	</ul>
	<h2>Zutaten</h2>
	<!-- ko foreach: components -->
	<h3 data-bind="text: title"></h3>
	<button type="button"><img alt="list-remove" src="images/tango/16x16/actions/list-remove.png"/></button>
	<table data-bind="foreach: ingredients">
		<tr>
			<!-- ko if: quantity -->
			<td data-bind="text:quantity().amount"></td>
			<td data-bind="text:quantity().unit"></td>
			<!-- /ko -->
			<!-- ko ifnot: quantity -->
			<td></td><td></td>
			<!-- /ko -->
			<td><a data-bind="text:ingredient().name, attr: {href: ingredient().url}"></a></td>
		</tr>
	</table>
	<!-- /ko -->
	<button type="button"><img alt="list-add" src="images/tango/16x16/actions/list-add.png"/></button>
	<h2>Zubereitung</h2>
	<!-- ko foreach: components -->
	<h3 data-bind="text: title"></h3>
	<div contentEditable="true" data-bind="html: preparation, event: {blur: updatePreparation}">
	</div>
	<!-- /ko -->
</div>
</form>
<form action="#">
	<textarea rows="20" cols="80" data-bind="text: json" style="width: 600px; height: 400px;"></textarea>
</form>

<script type='text/javascript'>
	$('[contenteditable]').live('focus', function() {
		var $this = $(this);
		$this.data('before', $this.html());
		return $this;
	}).live('blur keyup paste', function() {
		var $this = $(this);
		if ($this.data('before') !== $this.html()) {
			$this.data('before', $this.html());
			$this.trigger('change');
		}
		return $this;
    }).live('blur', function () {
        var $this = $(this);
        if ($this.data('before') !== $this.html()) {
            $this.data('before', $this.html());
            $this.trigger('blur');
        }
        return $this;
    });

	var serverData = {
		title: "Streuselkuchen",
		categories: ["Kuchen und Torten", "Kleingebäck"],
		author: {name: "Malte", url: "/user/malte"},
		views: 4428,
		rating: 3,
		image: { author: "Malte", src: "streuselkuchen.jpg", galleryUrl: "/gallery" },
		components: [
			{ 
				title: "Teig",
				preparation: "Mehl in eine Schüssel geben und eine Kuhle hineindrücken. Zucker, Hefe und lauwarmen Soja-Reis-Drink hineingeben. Mit einem Küchentuch zudecken und 15 Minuten lang gehen lassen. Margarine zerlassen und ebenfalls in die Kuhle geben. Von innenheraus mit dem restlichen Mehl verkneten. Nochmals 15 Minuten lang zugedeckt gehen lassen. Auf einem mit Backpapier ausgelegten Blech ausrollen und wieder 15 Minuten lang gehen lassen.",
				ingredients: [
					{ 
						quantity: {amount: 400, unit: "g" },
						ingredient: {name: "Mehl", url: "/Mehl"}
					},						
					{ 
						quantity: {amount: 75, unit: "g" },
						ingredient: {name: "Margarine", url: "/Margarine"}
					},
					{ 
						quantity: {amount: 75, unit: "g" },
						ingredient: {name: "Zucker", url: "/Zucker"}
					},						
					{ 
						quantity: {amount: 150, unit: "ml" },
						ingredient: {name: "Soja-Reis-Drink"}
					},						
					{ 
						quantity: {amount: 1, unit: "Pk" },
						ingredient: {name: "Hefe, trocken", url: "/Hefe"}
					},						
					{ 
						quantity: {amount: 1, unit: "Pk" },
						ingredient: {name: "Vanillezucker"},
						optional: true
					},						
					{ 
						ingredient: {name: "Salz", url: "/Salz"}
					}											
				]
			},
			{
				title: "Streusel",
				preparation: "Mehl, Zucker und Zimt vermischen, Margarine zerlassen und alles verkneten. Streusel auf dem ausgerollten, gegangenen Teig gleichmäßig verteilen und ca. 20 Minuten bei 180°C Umluft backen.",
				ingredients: [
					{ 
						quantity: {amount: 300, unit: "g" },
						ingredient: {name: "Mehl", url: "/Mehl"}
					},						
					{ 
						quantity: {amount: 175, unit: "g" },
						ingredient: {name: "Margarine", url: "/Margarine"}
					},
					{ 
						quantity: {amount: 300, unit: "g" },
						ingredient: {name: "Zucker", url: "/Zucker"}
					},						
					{ 
						ingredient: {name: "Zimt", url: "/Zimt"}
					}											
				]				
			}
		]
	};

	function QuantityModel(data)
	{
		this.amount = ko.observable(data.amount);
		this.unit = ko.observable(data.unit);
	}
	
	function IngredientModel(data)
	{
		this.name = ko.observable(data.name);
		this.url = ko.observable(data.url);
	}
	
	function RecipeIngredientModel(data)
	{
		this.quantity = ko.observable();
		if(data.quantity)
			this.quantity(new QuantityModel(data.quantity));
		this.ingredient = ko.observable();
		this.ingredient(new IngredientModel(data.ingredient));
	}
	
	function ComponentModel(data)
	{
		this.title = ko.observable(data.title);
		this.preparation = ko.observable(data.preparation);		
		this.ingredients = ko.observableArray();		
		this.ingredients($.map(data.ingredients, function(item) { return new RecipeIngredientModel(item) }));
		
		this.updatePreparation = function(model, event) {
			this.preparation($(event.target).html());
		}

	}
	
	function RecipeViewModel()
	{
		var self = this;
		self.data = ko.observable();

		//http://knockoutjs.com/documentation/plugins-mapping.html
		var mapping = {
			'components': {
				create: function(options) {
					return new ComponentModel(options.data);
					}
				//,
				//key: function(data) {
				//	return ko.utils.unwrapObservable(data.id);
				//}
			}
		}

		self.data(ko.mapping.fromJS(serverData, mapping))
		//var unmapped = ko.mapping.toJS(viewModel);
		
		self.json = ko.computed(function() {
			return ko.mapping.toJSON(self.data);			
    }, this);
	}
	
	var viewModel = new RecipeViewModel();
	ko.applyBindings(viewModel);
</script>
</body>
</html>